<?php
/**
 * Title: Boxes Element
 *
 * Description: Defines custom post type boxes. Defines markup for element "Boxes".
 *
 * Please do not edit this file. This file is part of the Cyber Chimps Framework and all modifications
 * should be made in a child theme.
 *
 * @category Cyber Chimps Framework
 * @package  Framework
 * @since    1.0
 * @author   CyberChimps
 * @license  http://www.opensource.org/licenses/gpl-license.php GPL v2.0 (or later)
 * @link     http://www.cyberchimps.com/
 */

// Don't load directly
if ( !defined('ABSPATH') ) { die('-1'); }

function cyberchimps_init_boxes_post_type() {

	// Register the custom post type "boxes"
	register_post_type( 'boxes',
		array(
			'labels' => array(
				'name'			=> __('Boxes', 'cyberchimps_elements' ),
				'singular_name'	=> __('Boxes', 'cyberchimps_elements' ),
			),
			'public'		=> true,
			'show_ui'		=> true, 
			'supports'		=> array('title'),
			'taxonomies'	=> array( 'boxes_categories'),
			'has_archive'	=> true,
			'menu_icon'		=> get_template_directory_uri() . '/cyberchimps/lib/images/custom-types/boxes.png',
			'rewrite'		=> array('slug' => 'boxes')
		)
	);
	
	// Define lebels to be supplied while registering custom category
	$labels = array(
		'name'				=> _x( 'Boxes Categories', 'taxonomy general name', 'cyberchimps_elements' ),
		'singular_name'		=> _x( 'Boxes Catergory', 'taxonomy singular name', 'cyberchimps_elements' ),
		'search_items'		=> __( 'Search Boxes', 'cyberchimps_elements' ),
		'all_items'			=> __( 'All Boxes', 'cyberchimps_elements' ),
		'parent_item'		=> __( 'Boxes Category', 'cyberchimps_elements' ),
		'parent_item_colon'	=> __( 'Boxes Category:', 'cyberchimps_elements' ),
		'edit_item'			=> __( 'Edit Boxes Category', 'cyberchimps_elements' ), 
		'update_item'		=> __( 'Update Boxes Category', 'cyberchimps_elements' ),
		'add_new_item'		=> __( 'Add New Boxes Category', 'cyberchimps_elements' ),
		'new_item_name'		=> __( 'New Boxes Category Name', 'cyberchimps_elements' ),
		'menu_name'			=> __( 'Boxes Category', 'cyberchimps_elements' )
	);
			
	// Register category for "boxes" posts
	register_taxonomy( 'boxes_categories',array('boxes'), array(
		'public'			=> true,
		'show_in_nav_menus'	=> false,
		'hierarchical'		=> true,
		'labels'			=> $labels,
		'show_ui'			=> true
	));
			
	$meta_boxes = array();
	
	$mb = new Chimps_Metabox('boxes', __( 'Boxes Element', 'cyberchimps_elements' ), array('pages' => array('boxes')));
	$mb
		->tab( __( 'Boxes Element', 'cyberchimps_elements' ) )
			->single_image('cyberchimps_box_image', __( 'Box Image', 'cyberchimps_elements' ), '')
			->text('cyberchimps_box_url', __( 'Box URL', 'cyberchimps_elements' ), '')
			->textarea('cyberchimps_box_text', __( 'Box Text', 'cyberchimps_elements' ), '')
		->end();
		
	foreach ($meta_boxes as $meta_box) {
		$my_box = new RW_Meta_Box_Taxonomy($meta_box);
	}
}
add_action( 'init', 'cyberchimps_init_boxes_post_type' );

add_action( 'boxes', 'cyberchimps_boxes_render_display' );

// Define content for boxes
function cyberchimps_boxes_render_display() {
	
	// Intialize box counter
	$box_counter = 1;
	
	// Set template directory uri
	$template_directory = get_template_directory_uri();
	
	// Get options for boxes.
	if ( is_page() ) {
		$customcategory	= get_post_meta( get_the_ID(), 'boxes_category' , true );
		$boxes_per_row	= get_post_meta( get_the_ID(), 'boxes_per_row' , true );
	}
	else {
		$customcategory	= cyberchimps_get_option( 'boxes_category', '' );
		$boxes_per_row	= cyberchimps_get_option( 'boxes_per_row', '' );
	}
	
	// Decide span width of boxes according to number of boxes per row.
	if( $boxes_per_row == 2 )	{
		$boxes_span = 'span6';
	}
	else if( $boxes_per_row == 3 )	{
		$boxes_span = 'span4';
	}
	if( $boxes_per_row == 4 )	{
		$boxes_span = 'span3';
	}
	
	// Custom box query
	$args = array(
					'numberposts'		=> $boxes_per_row,
					'offset'			=> 0,
					'boxes_categories'	=> $customcategory,
					'orderby'			=> 'post_date',
					'order'				=> 'ASC',
					'post_type'			=> 'boxes',
					'post_status'		=> 'publish',
					'suppress_filters' 	=> false
				);
	$boxes = get_posts( $args );
?>
	<div id="boxes-container" class="row-fluid">
		<div class="boxes">
		<?php
	if( $boxes && $customcategory != '' ):	
		foreach( $boxes as $box ):
				
				// Break after desired number of boxes displayed
				if( $box_counter > $boxes_per_row )
					break;
				
				// Get the image of the box
				$box_image = get_post_meta( $box->ID, 'cyberchimps_box_image', true );
				
				// Get the URL of the box
				$box_url = get_post_meta( $box->ID, 'cyberchimps_box_url', true );
				// Get the text of the box
				$box_text = get_post_meta( $box->ID, 'cyberchimps_box_text', true );
		?>	
				<div id="box<?php echo $box_counter?>" class="box <?php echo $boxes_span; ?>">
        <?php if( $box_url != '' && $box_image != '' ): ?>
					<a href="<?php echo $box_url; ?>" class="box-link">
						<img class="box-image" src="<?php echo $box_image; ?>" />
          </a>
        <?php else: ?>
			<?php if( $box_image != '' ): ?>
				<a class="box-no-url">
						<img class="box-image" src="<?php echo $box_image; ?>" />
				</a>
			<?php endif; ?>
        <?php endif; ?>
					<h2 class="box-widget-title"><?php echo $box->post_title; ?></h2>
					<p><?php echo $box_text; ?></p>
				</div><!--end box1-->
		<?php   
			$box_counter++;
			endforeach;
			else: ?>
				<div class="box span4">
					<a href="http://cyberchimps.com" class="box-link">
						<img class="box-image" src="<?php echo $template_directory; ?><?php echo apply_filters( 'cyberchimps_box1_image', '/elements/lib/images/boxes/slidericon.png' ); ?>" alt="CyberChimps Slider" />
          </a>
					<h2 class="box-widget-title"><?php _e( 'iFeature Pro 5 Slider', 'cyberchimps_elements' ); ?></h2>
					<p><?php _e( 'The New Touch Friendly iFeature Pro Slider now responds to any mobile touch device.', 'cyberchimps_elements' ); ?></p>
				</div><!--end box1-->
        
        <div class="box span4">
					<a href="http://cyberchimps.com" class="box-link">
						<img class="box-image" src="<?php echo $template_directory; ?><?php echo apply_filters( 'cyberchimps_box2_image', '/elements/lib/images/boxes/blueprint.png' ); ?>" alt="CyberChimps Blueprint" />
          </a>
					<h2 class="box-widget-title"><?php _e( 'Responsive Design', 'cyberchimps_elements' ); ?></h2>
					<p><?php _e( 'With iFeature Pro 5 and touch friendly responsive design you can now control your website on any device.', 'cyberchimps_elements' ); ?></p>
				</div><!--end box3-->
        
        <div class="box span4">
					<a href="http://cyberchimps.com" class="box-link">
						<img class="box-image" src="<?php echo $template_directory; ?><?php echo apply_filters( 'cyberchimps_box3_image', '/elements/lib/images/boxes/docs.png' ); ?>" alt="CyberChimps Help" />
          </a>
					<h2 class="box-widget-title"><?php _e( 'Excellent Support', 'cyberchimps_elements' ); ?></h2>
					<p><?php _e( 'Need help? Read the instructions and please visit our dedicated Pro Support Forum.', 'cyberchimps_elements' ); ?></p>
				</div><!--end box4-->
			
		<?php	endif;
		?>
		</div><!-- end boxes -->
	</div><!-- end row-fluid -->
<?php	
} 
?>